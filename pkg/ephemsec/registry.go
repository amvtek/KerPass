package ephemsec

import (
	"code.kerpass.org/golang/internal/utils"
)

const (
	// short code digits encode [code|pattern|hash|curve]
	// each registered short code corresponds to a unique EPHEMSEC scheme
	// short codes are used in KerPass airgap messages to save bandwidth

	SHA512_X25519_E1S1_T600B10P8     = uint16(0x1111)
	SHA512_256_X25519_E1S1_T600B10P8 = uint16(0x1121)
	BLAKE2S_X25519_E1S1_T600B10P8    = uint16(0x1131)
	BLAKE2B_X25519_E1S1_T600B10P8    = uint16(0x1143)

	SHA512_X25519_E1S2_T600B10P8     = uint16(0x1211)
	SHA512_256_X25519_E1S2_T600B10P8 = uint16(0x1221)
	BLAKE2S_X25519_E1S2_T600B10P8    = uint16(0x1231)
	BLAKE2B_X25519_E1S2_T600B10P8    = uint16(0x1241)

	SHA512_X25519_E2S2_T600B10P8     = uint16(0x1311)
	SHA512_256_X25519_E2S2_T600B10P8 = uint16(0x1321)
	BLAKE2S_X25519_E2S2_T600B10P8    = uint16(0x1331)
	BLAKE2B_X25519_E2S2_T600B10P8    = uint16(0x1341)

	SHA512_X25519_E1S1_T600B32P9     = uint16(0x2111)
	SHA512_256_X25519_E1S1_T600B32P9 = uint16(0x2121)
	BLAKE2S_X25519_E1S1_T600B32P9    = uint16(0x2131)
	BLAKE2B_X25519_E1S1_T600B32P9    = uint16(0x2141)

	SHA512_X25519_E1S2_T600B32P9     = uint16(0x2211)
	SHA512_256_X25519_E1S2_T600B32P9 = uint16(0x2221)
	BLAKE2S_X25519_E1S2_T600B32P9    = uint16(0x2231)
	BLAKE2B_X25519_E1S2_T600B32P9    = uint16(0x2241)

	SHA512_X25519_E2S2_T600B32P9     = uint16(0x2311)
	SHA512_256_X25519_E2S2_T600B32P9 = uint16(0x2321)
	BLAKE2S_X25519_E2S2_T600B32P9    = uint16(0x2331)
	BLAKE2B_X25519_E2S2_T600B32P9    = uint16(0x2341)

	SHA512_X25519_E1S1_T1024B256P33     = uint16(0x3111)
	SHA512_256_X25519_E1S1_T1024B256P33 = uint16(0x3121)
	BLAKE2S_X25519_E1S1_T1024B256P33    = uint16(0x3131)
	BLAKE2B_X25519_E1S1_T1024B256P33    = uint16(0x3141)

	SHA512_X25519_E1S2_T1024B256P33     = uint16(0x3211)
	SHA512_256_X25519_E1S2_T1024B256P33 = uint16(0x3221)
	BLAKE2S_X25519_E1S2_T1024B256P33    = uint16(0x3231)
	BLAKE2B_X25519_E1S2_T1024B256P33    = uint16(0x3241)

	SHA512_X25519_E2S2_T1024B256P33     = uint16(0x3311)
	SHA512_256_X25519_E2S2_T1024B256P33 = uint16(0x3321)
	BLAKE2S_X25519_E2S2_T1024B256P33    = uint16(0x3331)
	BLAKE2B_X25519_E2S2_T1024B256P33    = uint16(0x3341)
)

// GetScheme returns the EPHEMSEC scheme that corresponds to code.
// It errors if no scheme corresponds to code.
func GetScheme(code uint16) (*Scheme, error) {
	scm, found := utils.RegistryGet(shortCodeRegistry, code)
	if !found {
		return scm, newError("missing scheme")
	}
	rv := *scm
	return &rv, nil
}

var shortCodeRegistry *utils.Registry[uint16, *Scheme]

func mustRegister(code uint16, scheme string) {
	err := registerScheme(code, scheme)
	if nil != err {
		panic(err)
	}
}

func registerScheme(code uint16, scheme string) error {
	scm, err := NewScheme(scheme)
	if nil != err {
		return wrapError(err, "failed parsing scheme name")
	}
	return wrapError(
		utils.RegistrySet(shortCodeRegistry, code, scm),
		"failed registering scheme %s",
		scheme,
	)
}

func init() {
	shortCodeRegistry = utils.NewRegistry[uint16, *Scheme]()

	mustRegister(SHA512_X25519_E1S1_T600B10P8, "Kerpass_SHA512_X25519_E1S1_T600B10P8")
	mustRegister(SHA512_256_X25519_E1S1_T600B10P8, "Kerpass_SHA512/256_X25519_E1S1_T600B10P8")
	mustRegister(BLAKE2S_X25519_E1S1_T600B10P8, "Kerpass_BLAKE2s_X25519_E1S1_T600B10P8")
	mustRegister(BLAKE2B_X25519_E1S1_T600B10P8, "Kerpass_BLAKE2b_X25519_E1S1_T600B10P8")

	mustRegister(SHA512_X25519_E1S2_T600B10P8, "Kerpass_SHA512_X25519_E1S2_T600B10P8")
	mustRegister(SHA512_256_X25519_E1S2_T600B10P8, "Kerpass_SHA512/256_X25519_E1S2_T600B10P8")
	mustRegister(BLAKE2S_X25519_E1S2_T600B10P8, "Kerpass_BLAKE2s_X25519_E1S2_T600B10P8")
	mustRegister(BLAKE2B_X25519_E1S2_T600B10P8, "Kerpass_BLAKE2b_X25519_E1S2_T600B10P8")

	mustRegister(SHA512_X25519_E2S2_T600B10P8, "Kerpass_SHA512_X25519_E2S2_T600B10P8")
	mustRegister(SHA512_256_X25519_E2S2_T600B10P8, "Kerpass_SHA512/256_X25519_E2S2_T600B10P8")
	mustRegister(BLAKE2S_X25519_E2S2_T600B10P8, "Kerpass_BLAKE2s_X25519_E2S2_T600B10P8")
	mustRegister(BLAKE2B_X25519_E2S2_T600B10P8, "Kerpass_BLAKE2b_X25519_E2S2_T600B10P8")

	mustRegister(SHA512_X25519_E1S1_T600B32P9, "Kerpass_SHA512_X25519_E1S1_T600B32P9")
	mustRegister(SHA512_256_X25519_E1S1_T600B32P9, "Kerpass_SHA512/256_X25519_E1S1_T600B32P9")
	mustRegister(BLAKE2S_X25519_E1S1_T600B32P9, "Kerpass_BLAKE2s_X25519_E1S1_T600B32P9")
	mustRegister(BLAKE2B_X25519_E1S1_T600B32P9, "Kerpass_BLAKE2b_X25519_E1S1_T600B32P9")

	mustRegister(SHA512_X25519_E1S2_T600B32P9, "Kerpass_SHA512_X25519_E1S2_T600B32P9")
	mustRegister(SHA512_256_X25519_E1S2_T600B32P9, "Kerpass_SHA512/256_X25519_E1S2_T600B32P9")
	mustRegister(BLAKE2S_X25519_E1S2_T600B32P9, "Kerpass_BLAKE2s_X25519_E1S2_T600B32P9")
	mustRegister(BLAKE2B_X25519_E1S2_T600B32P9, "Kerpass_BLAKE2b_X25519_E1S2_T600B32P9")

	mustRegister(SHA512_X25519_E2S2_T600B32P9, "Kerpass_SHA512_X25519_E2S2_T600B32P9")
	mustRegister(SHA512_256_X25519_E2S2_T600B32P9, "Kerpass_SHA512/256_X25519_E2S2_T600B32P9")
	mustRegister(BLAKE2S_X25519_E2S2_T600B32P9, "Kerpass_BLAKE2s_X25519_E2S2_T600B32P9")
	mustRegister(BLAKE2B_X25519_E2S2_T600B32P9, "Kerpass_BLAKE2b_X25519_E2S2_T600B32P9")

	mustRegister(SHA512_X25519_E1S1_T1024B256P33, "Kerpass_SHA512_X25519_E1S1_T1024B256P33")
	mustRegister(SHA512_256_X25519_E1S1_T1024B256P33, "Kerpass_SHA512/256_X25519_E1S1_T1024B256P33")
	mustRegister(BLAKE2S_X25519_E1S1_T1024B256P33, "Kerpass_BLAKE2s_X25519_E1S1_T1024B256P33")
	mustRegister(BLAKE2B_X25519_E1S1_T1024B256P33, "Kerpass_BLAKE2b_X25519_E1S1_T1024B256P33")

	mustRegister(SHA512_X25519_E1S2_T1024B256P33, "Kerpass_SHA512_X25519_E1S2_T1024B256P33")
	mustRegister(SHA512_256_X25519_E1S2_T1024B256P33, "Kerpass_SHA512/256_X25519_E1S2_T1024B256P33")
	mustRegister(BLAKE2S_X25519_E1S2_T1024B256P33, "Kerpass_BLAKE2s_X25519_E1S2_T1024B256P33")
	mustRegister(BLAKE2B_X25519_E1S2_T1024B256P33, "Kerpass_BLAKE2b_X25519_E1S2_T1024B256P33")

	mustRegister(SHA512_X25519_E2S2_T1024B256P33, "Kerpass_SHA512_X25519_E2S2_T1024B256P33")
	mustRegister(SHA512_256_X25519_E2S2_T1024B256P33, "Kerpass_SHA512/256_X25519_E2S2_T1024B256P33")
	mustRegister(BLAKE2S_X25519_E2S2_T1024B256P33, "Kerpass_BLAKE2s_X25519_E2S2_T1024B256P33")
	mustRegister(BLAKE2B_X25519_E2S2_T1024B256P33, "Kerpass_BLAKE2b_X25519_E2S2_T1024B256P33")
}
